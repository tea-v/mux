Resources:
  MoviesDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        CacheBehaviors:
          - AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            Compress: true
            ForwardedValues:
              Cookies:
                Forward: none
              Headers:
                - Access-Control-Request-Headers
                - Access-Control-Request-Method
                - Origin
              QueryString: true
              QueryStringCacheKeys:
                - d
                - f
            LambdaFunctionAssociations:
              - EventType: viewer-request
                LambdaFunctionARN: ForwardImageRequestLambdaFunction
              - EventType: origin-response
                LambdaFunctionARN: ResizeImageLambdaFunction
            MinTTL: 100
            PathPattern: '*.jpg'
            SmoothStreaming: false
            TargetOriginId:
              Ref: MoviesBucket
            ViewerProtocolPolicy: redirect-to-https
          - AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            Compress: true
            ForwardedValues:
              Cookies:
                Forward: none
              Headers:
                - Access-Control-Request-Headers
                - Access-Control-Request-Method
                - Origin
              QueryString: true
              QueryStringCacheKeys:
                - d
                - f
            LambdaFunctionAssociations:
              - EventType: viewer-request
                LambdaFunctionARN: ForwardImageRequestLambdaFunction
              - EventType: origin-response
                LambdaFunctionARN: ResizeImageLambdaFunction
            MinTTL: 100
            PathPattern: '*.png'
            SmoothStreaming: false
            TargetOriginId:
              Ref: MoviesBucket
            ViewerProtocolPolicy: redirect-to-https
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            Cookies:
              Forward: none
            Headers:
              - Access-Control-Request-Headers
              - Access-Control-Request-Method
              - Origin
            QueryString: false
          LambdaFunctionAssociations:
            - EventType: viewer-request
              LambdaFunctionARN: AuthorizeUserLambdaFunction
          TargetOriginId:
            Ref: MoviesBucket
          ViewerProtocolPolicy: redirect-to-https
        Enabled: true
        Origins:
          - DomainName:
              Fn::Join:
                - ''
                - - Ref: MoviesBucket
                  - .s3.
                  - ${self:provider.region}
                  - .amazonaws.com
            Id:
              Ref: MoviesBucket
            S3OriginConfig:
              OriginAccessIdentity:
                Fn::Join:
                  - ''
                  - - origin-access-identity/cloudfront/
                    - Ref: MoviesBucketOriginAccessIdentity
        PriceClass: PriceClass_100
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
